<behaviourtemplates>

	<is name="childProcessor">
		{	
			"state" : "",
			"exploreFeatures" : {
				"trials" : 0,
				"maxTrials" : 4
			},
			"promptFeatures" : {
				"loadNextTrial":false,
				"trials" : 0,
				"maxTrials" : 4,
				"askedFeature" : "",
				"askedTimestamp" : 0,
				"repeats" : 0,
				"maxRepeats" : 2
			},
			"exploreExpressions" : {
				"trials" : 0,
				"maxTrials" : 4,
				"exploreEmotion" : ""
			},
			"promptExpressions" : {
				"trials" : 0,
				"maxTrials" : 4,
				"askedExpression" : ""
			}
		}
	</is>
	
	<javascript>
		<![CDATA[
		
			function askEqualsAnswer(prompt, answer) {
				return prompt.startsWith("prompt") && answer.startsWith("resolve") && prompt.slice(6).toLowerCase() === answer.slice(7).toLowerCase();
			}
			
			function answerIncorrectOrTimeout() {
				return (is.tablet.child.command !== "none" && !askEqualsAnswer(is.childProcessor.promptFeatures.askedFeature, is.tablet.child.command)) || (is.behaviourplanner.time - is.childProcessor.promptFeatures.askedTimestamp > 20000);
			}
			
		
		function getRandomFaceFeaturePrompt(previousPrompt){
			var faceFeatures = ["promptEyebrows","promptEyes","promptMouth"];
			faceFeatures.splice(faceFeatures.indexOf(previousPrompt), 1);
			return faceFeatures[Math.floor(Math.random() * faceFeatures.length)];
		}
			
		]]>
    </javascript>
      
    <!-- PINK GAME: Explore Features -->
    <template id="ExploreFeatures" name="ExploreFeatures">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "ExploreFeatures"</condition>
    		<condition>is.tablet.child.command !== "none"</condition>
    		<condition><![CDATA[is.childProcessor.exploreFeatures.trials < is.childProcessor.exploreFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.child.disableMenuRequest">"temporary"</assign>
    		<assign is="is.zeno.request">is.tablet.child.command</assign>
    		<assign is="is.childProcessor.exploreFeatures.trials">is.childProcessor.exploreFeatures.trials + 1</assign>
    	</effects>
    </template>
    
    <template id="ExploreFeaturesBlockEnd" name="ExploreFeaturesBlockEnd">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "ExploreFeatures"</condition>
    		<condition>is.tablet.child.command !== "none"</condition>
    		<condition><![CDATA[is.childProcessor.exploreFeatures.trials >= is.childProcessor.exploreFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.child.menuRequest">"blank"</assign>
    		<assign is="is.zeno.request">is.tablet.child.command</assign>
    	</effects>
    </template>
    
    <!-- BLUE GAME: Prompt Features -->
    <template id="PromptFeatures_Correct" name="PromptFeatures_Correct">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "PromptFeatures"</condition>
    		<condition>askEqualsAnswer(is.childProcessor.promptFeatures.askedFeature, is.tablet.child.command)</condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.trials < is.childProcessor.promptFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">is.tablet.child.command</assign>
    		<assign is="is.tablet.child.command">"none"</assign>
    		<assign is="is.childProcessor.promptFeatures.trials">is.childProcessor.promptFeatures.trials + 1</assign>
    		<assign is="is.childProcessor.promptFeatures.trialStartTime">is.behaviourplanner.time</assign>
    		<assign is="is.childProcessor.promptFeatures.loadNextTrial">true</assign>
    	</effects>
    </template>
    
    <template id="PromptFeatures_LoadNextTrial" name="PromptFeatures_LoadNextTrial">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "PromptFeatures"</condition>
    		<condition>!is.zeno.busy</condition>
    		<condition>is.childProcessor.promptFeatures.loadNextTrial</condition>
    		<condition><![CDATA[is.behaviourplanner.time - is.childProcessor.promptFeatures.trialStartTime > 1000]]></condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.trials < is.childProcessor.promptFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">is.tablet.child.command</assign>
    		<assign is="is.tablet.child.command">"none"</assign>
    		<assign is="is.childProcessor.promptFeatures.askedFeature">getRandomFaceFeaturePrompt(is.childProcessor.promptFeatures.askedFeature)</assign>
    		<assign is="is.childProcessor.promptFeatures.askedTimestamp">is.behaviourplanner.time</assign>
    		<assign is="is.childProcessor.promptFeatures.repeats">0</assign>
    		<assign is="is.childProcessor.promptFeatures.loadNextTrial">false</assign>
    		<assign is="is.child.enableMenuRequest">"later"</assign>
    		<assign is="is.zeno.request">is.childProcessor.promptFeatures.askedFeature</assign>
    	</effects>
    </template>
    
    <template id="PromptFeatures_Repeat" name="PromptFeatures_Repeat">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "PromptFeatures"</condition>
    		<condition>is.childProcessor.promptFeatures.askedFeature !== ""</condition>
    		<condition>answerIncorrectOrTimeout()</condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.repeats < is.childProcessor.promptFeatures.maxRepeats]]></condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.trials < is.childProcessor.promptFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.childProcessor.promptFeatures.repeats">is.childProcessor.promptFeatures.repeats + 1</assign>
    		<assign is="is.childProcessor.promptFeatures.askedTimestamp">is.behaviourplanner.time</assign>
    		<assign is="is.zeno.request">is.childProcessor.promptFeatures.askedFeature</assign>
    		<assign is="is.child.disableMenuRequest">"temporary"</assign>
    		<assign is="is.tablet.child.command">"none"</assign>
    	</effects>
    </template>
    
    <template id="PromptFeatures_TooManyAttempts" name="PromptFeatures_TooManyAttempts">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "PromptFeatures"</condition>
    		<condition>is.childProcessor.promptFeatures.askedFeature !== ""</condition>
    		<condition>answerIncorrectOrTimeout()</condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.repeats >= is.childProcessor.promptFeatures.maxRepeats]]></condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.trials < is.childProcessor.promptFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.childProcessor.promptFeatures.trials">is.childProcessor.promptFeatures.trials + 1</assign>
    		<assign is="is.childProcessor.promptFeatures.trialStartTime">is.behaviourplanner.time</assign>
    		<assign is="is.childProcessor.promptFeatures.loadNextTrial">true</assign>
    		<assign is="is.childProcessor.promptFeatures.askedTimestamp">0</assign>
    		<assign is="is.childProcessor.promptFeatures.repeats">0</assign>
    		<assign is="is.zeno.request">"letsTryAgain"</assign>
    		<assign is="is.tablet.child.command">"none"</assign>
    	</effects>
    </template>
    
    <template id="PromptFeaturesBlockEnd" name="PromptFeaturesBlockEnd">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "PromptFeatures"</condition>
    		<condition>is.tablet.child.command === "none"</condition>
    		<condition><![CDATA[is.childProcessor.promptFeatures.trials >= is.childProcessor.promptFeatures.maxTrials]]></condition>
    	</preconditions>
    	<effects>
    		<assign is="is.child.menuRequest">"blank"</assign>
    	</effects>
    </template>
    
    <!-- GREEN GAME: Explore Expressions -->
    <template id="ExploreExpressions" name="ExploreExpressions">
    	<preconditions mode="and">
    		<condition>is.child.showingMenu === "ExploreExpressions"</condition>
    		<condition>is.tablet.child.command !== "none"</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">is.tablet.child.command</assign>
    		<assign is="is.child.disableMenuRequest">"temporary"</assign>
    		<assign is="is.tablet.child.command">"none"</assign>
    	</effects>
    </template>
    
    <!-- YELLOW GAME: Prompt Expressions -->
    <template id="PromptExpressions_Happy_Correct" name="PromptExpressions_Happy_Correct">
    	<preconditions mode="and">
    		<condition><![CDATA[is.child.showingMenu === "PromptExpressions1d" || is.child.showingMenu === "PromptExpressions3d"]]></condition>
    		<condition>is.tablet.child.command === "happy"</condition>
    		<condition>is.tablet.child.command === is.childProcessor.promptExpressions.askedExpression</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">"wellDoneYouFoundMyHappyFace"</assign>
    		<assign is="is.child.menuRequest">"PromptExpressionsCorrect"</assign>
    	</effects>
    </template>
    
    <template id="PromptExpressions_Sad_Correct" name="PromptExpressions_Sad_Correct">
    	<preconditions mode="and">
    		<condition><![CDATA[is.child.showingMenu === "PromptExpressions1d" || is.child.showingMenu === "PromptExpressions3d"]]></condition>
    		<condition>is.tablet.child.command === "sad"</condition>
    		<condition>is.tablet.child.command === is.childProcessor.promptExpressions.askedExpression</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">"wellDoneYouFoundMySadFace"</assign>
    		<assign is="is.child.menuRequest">"PromptExpressionsCorrect"</assign>
    	</effects>
    </template>
    
    <template id="PromptExpressions_Angry_Correct" name="PromptExpressions_Angry_Correct">
    	<preconditions mode="and">
    		<condition><![CDATA[is.child.showingMenu === "PromptExpressions1d" || is.child.showingMenu === "PromptExpressions3d"]]></condition>
    		<condition>is.tablet.child.command === "angry"</condition>
    		<condition>is.tablet.child.command === is.childProcessor.promptExpressions.askedExpression</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">"wellDoneYouFoundMyAngryFace"</assign>
    		<assign is="is.child.menuRequest">"PromptExpressionsCorrect"</assign>
    	</effects>
    </template>
    
    <template id="PromptExpressions_Scared_Correct" name="PromptExpressions_Scared_Correct">
    	<preconditions mode="and">
    		<condition><![CDATA[is.child.showingMenu === "PromptExpressions1d" || is.child.showingMenu === "PromptExpressions3d"]]></condition>
    		<condition>is.tablet.child.command === "scared"</condition>
    		<condition>is.tablet.child.command === is.childProcessor.promptExpressions.askedExpression</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">"wellDoneYouFoundMyScaredFace"</assign>
    		<assign is="is.child.menuRequest">"PromptExpressionsCorrect"</assign>
    	</effects>
    </template>
    
    
    <template id="PromptExpressions_Incorrect" name="PromptExpressions_Incorrect">
    	<preconditions mode="and">
    		<condition><![CDATA[is.child.showingMenu === "PromptExpressions1d" || is.child.showingMenu === "PromptExpressions3d"]]></condition>
    		<condition>is.tablet.child.command !== "none"</condition>
    		<condition>is.tablet.child.command !== is.childProcessor.promptExpressions.askedExpression</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.zeno.request">"letsTryAgain"</assign>
    		<assign is="is.child.menuRequest">"NoImage"</assign>
    		<assign is="is.child.disableMenuRequest">"permanent"</assign>
    	</effects>
    </template>
    
    <!-- This template should always be last!! This gives multiple templates above the chance to simultanously process the input -->
    <template id="ChildCommandCleanup" name="ChildCommandCleanup">
    	<preconditions mode="and">
    		<condition>is.tablet.child.command !== "none"</condition>
    	</preconditions>
    	<effects>
    		<assign is="is.tablet.child.command">"none"</assign>
    	</effects>
    </template>
    
</behaviourtemplates>